name: Helm Chart OCI Publish

on:
    push:
        tags:
            - "v*"

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Helm
              uses: azure/setup-helm@v4
              with:
                  version: v3.14.0

            - name: Login to OCI Registry
              run: |
                  echo "${{ secrets.OCI_PASSWORD }}" | helm registry login ${{ secrets.OCI_REGISTRY }} --username "${{ secrets.OCI_USERNAME }}" --password-stdin

            - name: Package Helm Chart
              run: |
                  # Extract version from tag (removing 'v' prefix if present)
                  VERSION=${GITHUB_REF_NAME#v}
                  echo "Packaging chart with version: $VERSION"
                  helm package . --version "$VERSION" --app-version "$VERSION"

            - name: Push Helm Chart to OCI Registry
              run: |
                  # The chart name is extracted from Chart.yaml
                  CHART_NAME=$(grep '^name:' Chart.yaml | awk '{print $2}')
                  VERSION=${GITHUB_REF_NAME#v}
                  CHART_FILE="${CHART_NAME}-${VERSION}.tgz"

                  helm push "${CHART_FILE}" "oci://${{ secrets.OCI_REGISTRY }}/${{ secrets.OCI_REPO }}"
